define("factorys/MaterialFactory",["three","lodash","factorys/Factory","module"],function(s,n,e,t){var o={},p={},u=new s.MaterialLoader,i=(new s.TextureLoader,new s.ImageLoader),a=["color","emissive","specular"],r=new s.Color,l={texturePath:"textures/",defaultMatType:"MeshPhongMaterial",myPath:t.uri.substring(0,t.uri.lastIndexOf("/")+1)+"textures/",debug:!1,reflection:!1,WIDTH:window.innerWidth,HEIGHT:window.innerHeight,clipBias:.003,color:7829367},m=function(e,t){e&&(e.materials?this.addCatalog(e.materials):this.addCatalog(e)),this.options=n.extend({},l,t),this.textures={},this.materials={},i.setPath(this.options.texturePath),u.setTextures(this.textures)};return m.prototype=n.create(e.prototype,{constructor:m,loadCatalog:function(e,t){require(["json!"+e],function(e){this.addCatalog(e),"function"==typeof t&&t(this)}.bind(this))},loadPresets:function(e){require(["json!"+e],function(e){this.addPresets(e)}.bind(this))},addCatalog:function(e){n.each(e,function(t){t.userData||(t.userData={}),n.each(a,function(e){t[e]&&(t[e]instanceof Array&&(t.userData[e]=t[e],r.setRGB(t[e][0],t[e][1],t[e][2]),t[e]=r.getHex()),"string"==typeof t[e]&&(t.userData[e]=t[e],r.setStyle(t[e]),t[e]=r.getHex()))})}),n.extend(o,e)},addPresets:function(e){n.extend(p,e)},deleteMaterial:function(e){this.materials[e]&&(this.materials[e].dispose(),this.materials[e]=null)},enableReflection:function(e){this.VP=e,this.options.reflection=!0;var t=new s.CubeCamera(1,1e3,256);t.renderTarget.texture.minFilter=s.LinearMipMapLinearFilter,t.position.set(0,5,0),e.scene.add(t),this.planeMirror=t.renderTarget,e.loop.add(function(){t.updateCubeMap(e.renderer,e.scene)})},getMaterial:function(e,t){if(void 0===t&&(t=!0),!o[e])return null;if(this.materials[e])return t?this.materials[e].clone():this.materials[e];var a=o[e],r=n.clone(a),i={wrap:[],magFilter:[]};r.type||(r.type=l.defaultMatType),r.userData&&r.userData.preset&&p[r.userData.preset]&&(r=n.extend({},p[r.userData.preset],r)),a.map&&(r.map.wrap?("string"==typeof r.map.wrap[0]&&(r.map.wrap[0]=s[r.map.wrap[0]]),"string"==typeof r.map.wrap[1]&&(r.map.wrap[1]=s[r.map.wrap[1]])):r.map.rotation&&(r.map.wrap=[s.RepeatWrapping,s.RepeatWrapping]),r.userData&&r.userData.size&&function(e){var t={};if(e.userData.size){t.size=e.userData.size;var a=100/t.size[0],r=100/t.size[1];1===a&&(a=.9999),1===r&&(r=.9999),e.map.wrap||(e.map.wrap=[s.RepeatWrapping,s.RepeatWrapping]),e.map.repeat=[a,r]}}(r),i=n.extend(i,a.map),this._createTexture("map",r,i));return n.each(["bumpMap","roughnessMap","alphaMap","normalMap","emissiveMap","specularMap"],function(e){a[e]&&this._createTexture(e,r,i)}.bind(this)),a.envMap&&("flatMirror"===!a.envMap.image?this._createTexture("envMap",r,i):r.envMap=null),this.materials[e]=u.parse(r),r.userData&&(this.materials[e].userData=r.userData),a.envMap&&"flatMirror"===a.envMap.image&&this.options.reflection&&(this.materials[e].envMap=this.planeMirror,this.VP.loop.add(function(){this.materials[e].envMap=this.planeMirror.texture}.bind(this))),t?this.materials[e].clone():this.materials[e]},_createTexture:function(e,t,a){var r=t[e],i=e+"_"+r.image;if(this.textures[i])t[e]=i;else{var n={mapping:r.mapping||a.mapping,wrapS:r.wrap?r.wrap[0]:a.wrap[0],wrapT:r.wrap?r.wrap[1]:a.wrap[1],magFilter:r.magFilter?r.magFilter[0]:a.magFilter[0],minFilter:r.magFilter?r.magFilter[1]:a.magFilter[1],format:r.format||e.format,type:r.type||a.type,anisotropy:r.anisotropy||a.anisotropy,encoding:r.encoding||a.encoding,rotation:r.rotation?r.rotation:a.rotation||0,center:r.center?r.center:[0,0]};this.textures[i]=new s.Texture(void 0,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.encoding),r.repeat&&this.textures[i].repeat.fromArray(r.repeat),r.rotation&&(this.textures[i].rotation=r.rotation),t[e]=i,this.loadImage(this.textures[i],r.image)}},loadImage:function(a,r){i.load(r,function(e){var t=0<r.search(/\.(jpg|jpeg)$/)||0===r.search(/^data\:image\/jpeg/);a.format=t?1022:1023,a.image=e,a.needsUpdate=!0},function(){},function(){})}}),m}),define("threeVP-MaterialFactory",["factorys/MaterialFactory"],function(e){return{MaterialFactory:e}});